# DDMPC Project - Claude Context

## Project Overview

**DDMPC** (Data-Driven Model Predictive Control) is a framework that combines machine learning models with Model Predictive Control for building energy systems. The framework supports:

- **Process Models**: ANN, GPR, Linear Regression, WhiteBox (physics-based)
- **Controllers**: PID, Model Predictive Control (MPC)
- **Systems**: FMU, BopTest, Custom simulators

## Robotaxi Cabin Climate Control Extension

A new example was added for **autonomous robotaxi cabin climate control**. This demonstrates MPC for vehicle HVAC systems considering:

- Passenger load changes (boarding/alighting)
- Solar radiation dependent on driving direction
- Ambient temperature variations
- State of Charge (SOC) influencing cost function
- Vehicle velocity affecting radiator efficiency

### File Structure

```
Examples/Robotaxi/
├── configuration.py      # Features, variables, system definition
├── cabin_simulator.py    # Thermal cabin model (simulation environment)
├── controllers.py        # FixedPID controller (corrected anti-windup)
├── s2_generate_data.py   # PID baseline test
├── s3_T_cabin_WB.py      # WhiteBox model for MPC prediction
├── s4_mpc.py             # MPC vs PID comparison
└── *.png                 # Generated plots
```

### Physical Model

Single-zone energy balance:
```
C_cabin × dT/dt = Q_hp + Q_ptc + Q_solar + Q_passengers + Q_transmission
```

| Heat Flow | Formula |
|-----------|---------|
| Q_transmission | UA × (T_amb - T_cabin) |
| Q_solar | A_window × τ × I_solar × f(heading) |
| Q_passengers | n × 90 W |
| Q_hp | u × Q_hp_max × η_radiator(v) × COP (heating) or -u × Q_hp_max × η_radiator(v) (cooling) |
| Q_ptc | u × Q_ptc_max (only when T_amb < T_ptc_threshold) |

### HVAC System Components

1. **Heat Pump (Reversible)**
   - Cooling: COP = 1.5-4.0 (depends on T_amb - T_cabin)
   - Heating: COP = 1.2-4.0 (decreases with lower T_amb)
   - Max Cooling: 5,000 W
   - Max Heating: 4,000 W

2. **PTC Heater** (for very cold conditions)
   - COP = 1.0 (pure resistance heating)
   - Max Power: 6,000 W
   - Activation: T_amb < -5°C

3. **Automatic Mode Selection**
   - Cooling: when T_cabin > T_target + 0.5K
   - Heating: when T_cabin < T_target - 0.5K
   - Heating+PTC: when heating AND T_amb < -5°C

### COP Models

**Cooling COP:**
```python
COP_cool = min(4.0, max(1.5, 0.4 × T_cabin / max(T_amb - T_cabin, 5)))
```

**Heating COP (temperature dependent):**
| T_ambient | COP |
|-----------|-----|
| > 10°C | 4.0 |
| 0 to 10°C | 3.0-4.0 |
| -10 to 0°C | 2.0-3.0 |
| < -10°C | 1.2-2.0 |

### Parameters (Default)

| Parameter | Value | Description |
|-----------|-------|-------------|
| C_cabin | 50,000 J/K | Thermal capacity |
| UA | 80 W/K | Heat transfer coefficient |
| A_window | 2.5 m² | Window area |
| tau_window | 0.6 | Window transmittance |
| Q_hp_max_cool | 5,000 W | Max HP cooling power |
| Q_hp_max_heat | 4,000 W | Max HP heating power |
| Q_ptc_max | 6,000 W | Max PTC power |
| T_ptc_threshold | -5°C | PTC activation threshold |
| T_target | 22°C | Comfort target |

### Scenarios

| Scenario | T_ambient | Description |
|----------|-----------|-------------|
| `summer_city` | 30-35°C | Hot, city traffic, varying passengers |
| `winter_highway` | -10 to -5°C | Cold, highway, PTC active |
| `winter_city` | -5 to -2°C | Cold, city traffic, borderline PTC |
| `mild_mixed` | 20-24°C | Mild, mixed traffic |

### Energy Consumption (FixedPID, 4h simulation)

| Scenario | HP Energy | PTC Energy | Total | PTC Share |
|----------|-----------|------------|-------|-----------|
| Summer City | 1,203 Wh | 0 Wh | 1,203 Wh | 0% |
| Winter Highway | 2,308 Wh | 3,833 Wh | 6,141 Wh | 62% |

### PID Stability (FixedPID, verified)

| Scenario | Mean Temp | Std Dev | Status |
|----------|-----------|---------|--------|
| Summer City | 22.0°C | 0.25 K | PASS |
| Winter Highway | 22.9°C | 1.58 K | PASS |

## Development Environment

### Virtual Environment

Location: `/Users/unger/Developer/code/DDMPC/venv`

### Running Examples

```bash
cd /Users/unger/Developer/code/DDMPC

# Activate environment
source venv/bin/activate

# Run PID baseline
PYTHONPATH=. python Examples/Robotaxi/s2_generate_data.py

# Run MPC comparison
PYTHONPATH=. python Examples/Robotaxi/s4_mpc.py
```

### Key Dependencies

- casadi (optimization/MPC solver)
- numpy, pandas (data handling)
- matplotlib (plotting)
- keras, tensorflow (ANN models - optional)
- scikit-learn (GPR models - optional)
- fmpy (FMU simulation)

## Code Conventions

### PID Controller

**Important:** The standard DDMPC `PID` has an anti-windup bug (see Known Issues). Always use `FixedPID` from `Examples/Robotaxi/controllers.py` for stable operation.

```python
from controllers import FixedPID

# For cooling scenarios (reverse_act=True)
pid = FixedPID(
    y=T_cabin,           # Controlled variable (Controlled)
    u=u_hvac,            # Control variable (Control)
    step_size=one_minute,
    Kp=0.5,              # Proportional gain
    Ti=100.0,            # Integral time constant [s]
    Td=0.0,              # Derivative time constant
    reverse_act=True,    # True for cooling (increase u when T > target)
)

# For heating scenarios (reverse_act=False)
pid = FixedPID(
    y=T_cabin,
    u=u_hvac,
    step_size=one_minute,
    Kp=0.3,
    Ti=150.0,
    reverse_act=False,   # False for heating
)
```

### WhiteBox Model

WhiteBox models use CasADi symbolic expressions for physics-based prediction:

```python
WhiteBox(
    inputs=[source1, source2, ...],
    output=output_change_connection,
    output_expression=casadi_expression,
    step_size=one_minute,
)
```

### Feature Types

| Type | Purpose |
|------|---------|
| `Controlled` | Variables to be controlled (with target/bounds) |
| `Control` | Manipulated variables (with lb/ub) |
| `Disturbance` | External inputs with forecasts |
| `Connection` | Derived/calculated variables |
| `Tracking` | Monitoring only |

## Known Issues & Fixes

### PID Anti-Windup Bug (CRITICAL)

The standard DDMPC PID controller (`ddmpc/controller/conventional.py`) has a bug in its anti-windup logic:

```python
# Bug in ddmpc/controller/conventional.py line 136:
self.i = output / self.Kp - e
```

When `output=0` (saturated) and `e` is negative (T > target for heating), this sets the integral to a **large positive value**, causing the controller to keep heating even when temperature is way above target. This leads to severe oscillations (15-35°C swings).

**Solution:** Use `FixedPID` from `Examples/Robotaxi/controllers.py` which has corrected anti-windup:
- Only integrates when not saturated in the wrong direction
- Clamps integral to `[-max_integral, max_integral]` where `max_integral = (ub - lb) / Kp`
- Verified stable across summer (cooling) and winter (heating+PTC) scenarios

### Locale Error on macOS

The plotting module had a Windows-specific locale setting. Fixed in `ddmpc/utils/plotting.py`:

```python
# Cross-platform locale setting
for loc in ['de_DE.UTF-8', 'de_DE', 'deu_deu', '']:
    try:
        locale.setlocale(locale.LC_ALL, loc)
        break
    except locale.Error:
        continue
```

## References

- RWTH Aachen Dissertation: "Model predictive thermal control of a vehicle cabin with multiple zones and compensation of environmental disturbances" (Poovendran, 2024)
- DOI: 10.18154/RWTH-2025-05081

## Next Steps / TODO

- [ ] Implement and test MPC controller for Robotaxi
- [ ] Add SOC-dependent cost function to MPC
- [ ] Compare MPC vs PID energy savings
- [ ] Add multi-zone cabin model (optional)
- [ ] Validate with real vehicle data (future)